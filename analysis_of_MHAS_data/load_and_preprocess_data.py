import numpy as np
import pandas as pd
from sklearn.preprocessing import LabelEncoder
import os

#this is a list of the cognitive features of the dataset
# see https://www.mhasweb.org/resources/DATA/HarmonizedData/H_MHAS/Version_C2/Harmonized_MHAS_C.2_2001_2018.pdf
cognitive_variables = ['R1NOVISUAL', 'R2NOVISUAL', 'R3NOVISUAL', 'R4NOVISUAL',
       'R5NOVISUAL', 'S1NOVISUAL', 'S2NOVISUAL', 'S3NOVISUAL',
       'S4NOVISUAL', 'S5NOVISUAL', 'R1NOPENCIL', 'R2NOPENCIL',
       'R3NOPENCIL', 'R4NOPENCIL', 'R5NOPENCIL', 'S1NOPENCIL',
       'S2NOPENCIL', 'S3NOPENCIL', 'S4NOPENCIL', 'S5NOPENCIL', 'R3SLFMEM',
       'R4SLFMEM', 'R5SLFMEM', 'S3SLFMEM', 'S4SLFMEM', 'S5SLFMEM',
       'R3PSTMEM', 'R4PSTMEM', 'R5PSTMEM', 'S3PSTMEM', 'S4PSTMEM',
       'S5PSTMEM', 'R1IMRC8', 'R2IMRC8', 'R3IMRC8', 'R4IMRC8', 'R5IMRC8',
       'S1IMRC8', 'S2IMRC8', 'S3IMRC8', 'S4IMRC8', 'S5IMRC8', 'R1FIMRC8',
       'R2FIMRC8', 'R3FIMRC8', 'R4FIMRC8', 'R5FIMRC8', 'S1FIMRC8',
       'S2FIMRC8', 'S3FIMRC8', 'S4FIMRC8', 'S5FIMRC8', 'R1DLRC8',
       'R2DLRC8', 'R3DLRC8', 'R4DLRC8', 'R5DLRC8', 'S1DLRC8', 'S2DLRC8',
       'S3DLRC8', 'S4DLRC8', 'S5DLRC8', 'R1FDLRC8', 'R2FDLRC8',
       'R3FDLRC8', 'R4FDLRC8', 'R5FDLRC8', 'S1FDLRC8', 'S2FDLRC8',
       'S3FDLRC8', 'S4FDLRC8', 'S5FDLRC8', 'R1TR16', 'R2TR16', 'R3TR16',
       'R4TR16', 'R5TR16', 'S1TR16', 'S2TR16', 'S3TR16', 'S4TR16',
       'S5TR16', 'R1FTR16', 'R2FTR16', 'R3FTR16', 'R4FTR16', 'R5FTR16',
       'S1FTR16', 'S2FTR16', 'S3FTR16', 'S4FTR16', 'S5FTR16', 'R1IDRAW2',
       'R2IDRAW2', 'S1IDRAW2', 'S2IDRAW2', 'R1FIDRAW2', 'R2FIDRAW2',
       'S1FIDRAW2', 'S2FIDRAW2', 'R3IDRAW1', 'R4IDRAW1', 'R5IDRAW1',
       'S3IDRAW1', 'S4IDRAW1', 'S5IDRAW1', 'R3FIDRAW1', 'R4FIDRAW1',
       'R5FIDRAW1', 'S3FIDRAW1', 'S4FIDRAW1', 'S5FIDRAW1', 'R1DDRAW2',
       'R2DDRAW2', 'S1DDRAW2', 'S2DDRAW2', 'R1FDDRAW2', 'R2FDDRAW2',
       'S1FDDRAW2', 'S2FDDRAW2', 'R3DDRAW1', 'R4DDRAW1', 'R5DDRAW1',
       'S3DDRAW1', 'S4DDRAW1', 'S5DDRAW1', 'R3FDDRAW1', 'R4FDDRAW1',
       'R5FDDRAW1', 'S3FDDRAW1', 'S4FDDRAW1', 'S5FDDRAW1', 'R3VERBF',
       'R4VERBF', 'R5VERBF', 'S3VERBF', 'S4VERBF', 'S5VERBF', 'R3FVERBF',
       'R4FVERBF', 'R5FVERBF', 'S3FVERBF', 'S4FVERBF', 'S5FVERBF',
       'R1VSCAN', 'R2VSCAN', 'R3VSCAN', 'R4VSCAN', 'R5VSCAN', 'S1VSCAN',
       'S2VSCAN', 'S3VSCAN', 'S4VSCAN', 'S5VSCAN', 'R1FVSCAN', 'R2FVSCAN',
       'R3FVSCAN', 'R4FVSCAN', 'R5FVSCAN', 'S1FVSCAN', 'S2FVSCAN',
       'S3FVSCAN', 'S4FVSCAN', 'S5FVSCAN', 'R3BWC20', 'R4BWC20',
       'S3BWC20', 'S4BWC20', 'R3BWC20_M', 'R4BWC20_M', 'S3BWC20_M',
       'S4BWC20_M', 'R3FBWC20_M', 'R4FBWC20_M', 'S3FBWC20_M',
       'S4FBWC20_M', 'R2DY', 'R3DY', 'R4DY', 'R5DY', 'S2DY', 'S3DY',
       'S4DY', 'S5DY', 'R2FDY', 'R3FDY', 'R4FDY', 'R5FDY', 'S2FDY',
       'S3FDY', 'S4FDY', 'S5FDY', 'R2MO', 'R3MO', 'R4MO', 'R5MO', 'S2MO',
       'S3MO', 'S4MO', 'S5MO', 'R2FMO', 'R3FMO', 'R4FMO', 'R5FMO',
       'S2FMO', 'S3FMO', 'S4FMO', 'S5FMO', 'R2YR', 'R3YR', 'R4YR', 'R5YR',
       'S2YR', 'S3YR', 'S4YR', 'S5YR', 'R2FYR', 'R3FYR', 'R4FYR', 'R5FYR',
       'S2FYR', 'S3FYR', 'S4FYR', 'S5FYR', 'R2ORIENT_M', 'R3ORIENT_M',
       'R4ORIENT_M', 'R5ORIENT_M', 'S2ORIENT_M', 'S3ORIENT_M',
       'S4ORIENT_M', 'S5ORIENT_M', 'R2FORIENT_M', 'R3FORIENT_M',
       'R4FORIENT_M', 'R5FORIENT_M', 'S2FORIENT_M', 'S3FORIENT_M',
       'S4FORIENT_M', 'S5FORIENT_M', 'R4SER7', 'R5SER7', 'S4SER7',
       'S5SER7', 'R4FSER7', 'R5FSER7', 'S4FSER7', 'S5FSER7',
       'R1CIQSCORE1', 'R2CIQSCORE1', 'R3CIQSCORE1', 'R4CIQSCORE1',
       'R5CIQSCORE1', 'S1CIQSCORE1', 'S2CIQSCORE1', 'S3CIQSCORE1',
       'S4CIQSCORE1', 'S5CIQSCORE1', 'R1FCIQSCORE1', 'R2FCIQSCORE1',
       'R3FCIQSCORE1', 'R4FCIQSCORE1', 'R5FCIQSCORE1', 'S1FCIQSCORE1',
       'S2FCIQSCORE1', 'S3FCIQSCORE1', 'S4FCIQSCORE1', 'S5FCIQSCORE1',
       'R1CIQSCORE2', 'R2CIQSCORE2', 'R3CIQSCORE2', 'R4CIQSCORE2',
       'R5CIQSCORE2', 'S1CIQSCORE2', 'S2CIQSCORE2', 'S3CIQSCORE2',
       'S4CIQSCORE2', 'S5CIQSCORE2', 'R1FCIQSCORE2', 'R2FCIQSCORE2',
       'R3FCIQSCORE2', 'R4FCIQSCORE2', 'R5FCIQSCORE2', 'S1FCIQSCORE2',
       'S2FCIQSCORE2', 'S3FCIQSCORE2', 'S4FCIQSCORE2', 'S5FCIQSCORE2',
       'R1CIQSCORE3', 'R2CIQSCORE3', 'R3CIQSCORE3', 'R4CIQSCORE3',
       'R5CIQSCORE3', 'S1CIQSCORE3', 'S2CIQSCORE3', 'S3CIQSCORE3',
       'S4CIQSCORE3', 'S5CIQSCORE3', 'R1FCIQSCORE3', 'R2FCIQSCORE3',
       'R3FCIQSCORE3', 'R4FCIQSCORE3', 'R5FCIQSCORE3', 'S1FCIQSCORE3',
       'S2FCIQSCORE3', 'S3FCIQSCORE3', 'S4FCIQSCORE3', 'S5FCIQSCORE3',
       'R1CIQSCORE4', 'R2CIQSCORE4', 'R3CIQSCORE4', 'R4CIQSCORE4',
       'R5CIQSCORE4', 'S1CIQSCORE4', 'S2CIQSCORE4', 'S3CIQSCORE4',
       'S4CIQSCORE4', 'S5CIQSCORE4', 'R1FCIQSCORE4', 'R2FCIQSCORE4',
       'R3FCIQSCORE4', 'R4FCIQSCORE4', 'R5FCIQSCORE4', 'S1FCIQSCORE4',
       'S2FCIQSCORE4', 'S3FCIQSCORE4', 'S4FCIQSCORE4', 'S5FCIQSCORE4',
       'R1CIQSCORE5', 'R2CIQSCORE5', 'R3CIQSCORE5', 'R4CIQSCORE5',
       'R5CIQSCORE5', 'S1CIQSCORE5', 'S2CIQSCORE5', 'S3CIQSCORE5',
       'S4CIQSCORE5', 'S5CIQSCORE5', 'R1FCIQSCORE5', 'R2FCIQSCORE5',
       'R3FCIQSCORE5', 'R4FCIQSCORE5', 'R5FCIQSCORE5', 'S1FCIQSCORE5',
       'S2FCIQSCORE5', 'S3FCIQSCORE5', 'S4FCIQSCORE5', 'S5FCIQSCORE5',
       'R1CIQSCORE6', 'R2CIQSCORE6', 'R3CIQSCORE6', 'R4CIQSCORE6',
       'R5CIQSCORE6', 'S1CIQSCORE6', 'S2CIQSCORE6', 'S3CIQSCORE6',
       'S4CIQSCORE6', 'S5CIQSCORE6', 'R1FCIQSCORE6', 'R2FCIQSCORE6',
       'R3FCIQSCORE6', 'R4FCIQSCORE6', 'R5FCIQSCORE6', 'S1FCIQSCORE6',
       'S2FCIQSCORE6', 'S3FCIQSCORE6', 'S4FCIQSCORE6', 'S5FCIQSCORE6',
       'R1CIQSCORE7', 'R2CIQSCORE7', 'R3CIQSCORE7', 'R4CIQSCORE7',
       'R5CIQSCORE7', 'S1CIQSCORE7', 'S2CIQSCORE7', 'S3CIQSCORE7',
       'S4CIQSCORE7', 'S5CIQSCORE7', 'R1FCIQSCORE7', 'R2FCIQSCORE7',
       'R3FCIQSCORE7', 'R4FCIQSCORE7', 'R5FCIQSCORE7', 'S1FCIQSCORE7',
       'S2FCIQSCORE7', 'S3FCIQSCORE7', 'S4FCIQSCORE7', 'S5FCIQSCORE7',
       'R1CIQSCORE8', 'R2CIQSCORE8', 'R3CIQSCORE8', 'R4CIQSCORE8',
       'R5CIQSCORE8', 'S1CIQSCORE8', 'S2CIQSCORE8', 'S3CIQSCORE8',
       'S4CIQSCORE8', 'S5CIQSCORE8', 'R1FCIQSCORE8', 'R2FCIQSCORE8',
       'R3FCIQSCORE8', 'R4FCIQSCORE8', 'R5FCIQSCORE8', 'S1FCIQSCORE8',
       'S2FCIQSCORE8', 'S3FCIQSCORE8', 'S4FCIQSCORE8', 'S5FCIQSCORE8',
       'R1CIQSCORE9', 'R2CIQSCORE9', 'R3CIQSCORE9', 'R4CIQSCORE9',
       'R5CIQSCORE9', 'S1CIQSCORE9', 'S2CIQSCORE9', 'S3CIQSCORE9',
       'S4CIQSCORE9', 'S5CIQSCORE9', 'R1FCIQSCORE9', 'R2FCIQSCORE9',
       'R3FCIQSCORE9', 'R4FCIQSCORE9', 'R5FCIQSCORE9', 'S1FCIQSCORE9',
       'S2FCIQSCORE9', 'S3FCIQSCORE9', 'S4FCIQSCORE9', 'S5FCIQSCORE9',
       'R1CIQSCORE10', 'R2CIQSCORE10', 'R3CIQSCORE10', 'R4CIQSCORE10',
       'R5CIQSCORE10', 'S1CIQSCORE10', 'S2CIQSCORE10', 'S3CIQSCORE10',
       'S4CIQSCORE10', 'S5CIQSCORE10', 'R1FCIQSCORE10', 'R2FCIQSCORE10',
       'R3FCIQSCORE10', 'R4FCIQSCORE10', 'R5FCIQSCORE10', 'S1FCIQSCORE10',
       'S2FCIQSCORE10', 'S3FCIQSCORE10', 'S4FCIQSCORE10', 'S5FCIQSCORE10',
       'R1CIQSCORE11', 'R2CIQSCORE11', 'R3CIQSCORE11', 'R4CIQSCORE11',
       'R5CIQSCORE11', 'S1CIQSCORE11', 'S2CIQSCORE11', 'S3CIQSCORE11',
       'S4CIQSCORE11', 'S5CIQSCORE11', 'R1FCIQSCORE11', 'R2FCIQSCORE11',
       'R3FCIQSCORE11', 'R4FCIQSCORE11', 'R5FCIQSCORE11', 'S1FCIQSCORE11',
       'S2FCIQSCORE11', 'S3FCIQSCORE11', 'S4FCIQSCORE11', 'S5FCIQSCORE11',
       'R1CIQSCORE12', 'R2CIQSCORE12', 'R3CIQSCORE12', 'R4CIQSCORE12',
       'R5CIQSCORE12', 'S1CIQSCORE12', 'S2CIQSCORE12', 'S3CIQSCORE12',
       'S4CIQSCORE12', 'S5CIQSCORE12', 'R1FCIQSCORE12', 'R2FCIQSCORE12',
       'R3FCIQSCORE12', 'R4FCIQSCORE12', 'R5FCIQSCORE12', 'S1FCIQSCORE12',
       'S2FCIQSCORE12', 'S3FCIQSCORE12', 'S4FCIQSCORE12', 'S5FCIQSCORE12',
       'R1CIQSCORE13', 'R2CIQSCORE13', 'R3CIQSCORE13', 'R4CIQSCORE13',
       'R5CIQSCORE13', 'S1CIQSCORE13', 'S2CIQSCORE13', 'S3CIQSCORE13',
       'S4CIQSCORE13', 'S5CIQSCORE13', 'R1FCIQSCORE13', 'R2FCIQSCORE13',
       'R3FCIQSCORE13', 'R4FCIQSCORE13', 'R5FCIQSCORE13', 'S1FCIQSCORE13',
       'S2FCIQSCORE13', 'S3FCIQSCORE13', 'S4FCIQSCORE13', 'S5FCIQSCORE13',
       'R1CIQSCORE14', 'R2CIQSCORE14', 'R3CIQSCORE14', 'R4CIQSCORE14',
       'R5CIQSCORE14', 'S1CIQSCORE14', 'S2CIQSCORE14', 'S3CIQSCORE14',
       'S4CIQSCORE14', 'S5CIQSCORE14', 'R1FCIQSCORE14', 'R2FCIQSCORE14',
       'R3FCIQSCORE14', 'R4FCIQSCORE14', 'R5FCIQSCORE14', 'S1FCIQSCORE14',
       'S2FCIQSCORE14', 'S3FCIQSCORE14', 'S4FCIQSCORE14', 'S5FCIQSCORE14',
       'R1CIQSCORE15', 'R2CIQSCORE15', 'R3CIQSCORE15', 'R4CIQSCORE15',
       'R5CIQSCORE15', 'S1CIQSCORE15', 'S2CIQSCORE15', 'S3CIQSCORE15',
       'S4CIQSCORE15', 'S5CIQSCORE15', 'R1FCIQSCORE15', 'R2FCIQSCORE15',
       'R3FCIQSCORE15', 'R4FCIQSCORE15', 'R5FCIQSCORE15', 'S1FCIQSCORE15',
       'S2FCIQSCORE15', 'S3FCIQSCORE15', 'S4FCIQSCORE15', 'S5FCIQSCORE15',
       'R1CIQSCORE16', 'R2CIQSCORE16', 'R3CIQSCORE16', 'R4CIQSCORE16',
       'R5CIQSCORE16', 'S1CIQSCORE16', 'S2CIQSCORE16', 'S3CIQSCORE16',
       'S4CIQSCORE16', 'S5CIQSCORE16', 'R1FCIQSCORE16', 'R2FCIQSCORE16',
       'R3FCIQSCORE16', 'R4FCIQSCORE16', 'R5FCIQSCORE16', 'S1FCIQSCORE16',
       'S2FCIQSCORE16', 'S3FCIQSCORE16', 'S4FCIQSCORE16', 'S5FCIQSCORE16',
       'R1CJORMSCORE', 'R2CJORMSCORE', 'R3CJORMSCORE', 'R4CJORMSCORE',
       'R5CJORMSCORE', 'S1CJORMSCORE', 'S2CJORMSCORE', 'S3CJORMSCORE',
       'S4CJORMSCORE', 'S5CJORMSCORE', 'R1PRMEM', 'R2PRMEM', 'R3PRMEM',
       'R4PRMEM', 'R5PRMEM', 'S1PRMEM', 'S2PRMEM', 'S3PRMEM', 'S4PRMEM',
       'S5PRMEM', 'R1PRCHMEM', 'R2PRCHMEM', 'R3PRCHMEM', 'R4PRCHMEM',
       'R5PRCHMEM', 'S1PRCHMEM', 'S2PRCHMEM', 'S3PRCHMEM', 'S4PRCHMEM',
       'S5PRCHMEM', 'R1RJUDG', 'R2RJUDG', 'R3RJUDG', 'R4RJUDG', 'R5RJUDG',
       'S1RJUDG', 'S2RJUDG', 'S3RJUDG', 'S4RJUDG', 'S5RJUDG', 'R1RORGNZ',
       'R2RORGNZ', 'R3RORGNZ', 'R4RORGNZ', 'R5RORGNZ', 'S1RORGNZ',
       'S2RORGNZ', 'S3RORGNZ', 'S4RORGNZ', 'S5RORGNZ', 'R1LOST', 'R2LOST',
       'R3LOST', 'R4LOST', 'R5LOST', 'S1LOST', 'S2LOST', 'S3LOST',
       'S4LOST', 'S5LOST', 'R1WANDER', 'R2WANDER', 'R3WANDER', 'R4WANDER',
       'R5WANDER', 'S1WANDER', 'S2WANDER', 'S3WANDER', 'S4WANDER',
       'S5WANDER', 'R1ALONE', 'R2ALONE', 'R3ALONE', 'R4ALONE', 'R5ALONE',
       'S1ALONE', 'S2ALONE', 'S3ALONE', 'S4ALONE', 'S5ALONE', 'R1HALUC',
       'R2HALUC', 'R3HALUC', 'R4HALUC', 'R5HALUC', 'S1HALUC', 'S2HALUC',
       'S3HALUC', 'S4HALUC', 'S5HALUC', 'R1OANGRY', 'R2OANGRY',
       'R3OANGRY', 'R4OANGRY', 'S1OANGRY', 'S2OANGRY', 'S3OANGRY',
       'S4OANGRY', 'R1OSLEEP', 'R2OSLEEP', 'R3OSLEEP', 'R4OSLEEP',
       'S1OSLEEP', 'S2OSLEEP', 'S3OSLEEP', 'S4OSLEEP', 'R1ODNGR',
       'R2ODNGR', 'R3ODNGR', 'R4ODNGR', 'S1ODNGR', 'S2ODNGR', 'S3ODNGR',
       'S4ODNGR', 'R1OPACE', 'R2OPACE', 'R3OPACE', 'R4OPACE', 'S1OPACE',
       'S2OPACE', 'S3OPACE', 'S4OPACE', 'R1OPLOT', 'R2OPLOT', 'R3OPLOT',
       'R4OPLOT', 'S1OPLOT', 'S2OPLOT', 'S3OPLOT', 'S4OPLOT', 'R1OALCHL',
       'R2OALCHL', 'R3OALCHL', 'R4OALCHL', 'S1OALCHL', 'S2OALCHL',
       'S3OALCHL', 'S4OALCHL']



base_dir = os.getcwd()
        
data_found = False
print('reading data, please be patient')
try:
    df =pd.read_stata(os.path.join( base_dir, 'analysis_of_MHAS_data','H_MHAS_c2.dta'))
    data_found = True
except:
    print('H_MHAS_c2.dta file not found in the analysis_of_MHAS_data folder')
    print('please download the H MHAS Data File from https://www.mhasweb.org/DataProducts/HarmonizedData.aspx')
        
    
if data_found:
    cols = np.array([i.upper() for i in df.columns])
    df.columns = cols
    
    features = [ i for i in df.columns if i not in cognitive_variables]
    print('saving the features')
    df[features].to_csv(os.path.join( base_dir, 'analysis_of_MHAS_data','features.csv',index= False))
   
    print('features saved, computing the mean cognitive score now')
    df = df[cognitive_variables]
    
    categorical = [ i for i in df.dtypes.index if df.dtypes.loc[i] !='float64']
    
    le = LabelEncoder()
    for i in categorical:
        df[i] = le.fit_transform(df[i])
        
    #z-score
    for i in df.columns:
        df[i] = (df[i]-df[i].mean())/df[i].std()
     
    print('saving the mean cognitive score now')
    df.mean(1).to_csv(os.path.join( base_dir, 'analysis_of_MHAS_data','target.csv'),index= False)
    print('all variables saved')
